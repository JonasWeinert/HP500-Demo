name: Compile LaTeX Outputs Report

on:
  push:
    branches:
      - github-automations

jobs:
  build_latex:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to get commit information
      
      - name: Get git metadata
        id: git_info
        run: |
          # Get current date
          CURRENT_DATE=$(date '+%B %d, %Y at %H:%M UTC')
          echo "date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          
          # Get commit author name
          AUTHOR_NAME=$(git log -1 --pretty=format:'%an')
          echo "author=$AUTHOR_NAME" >> $GITHUB_OUTPUT
          
          # Get all commits from this push (between before and after)
          if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            # This is the first commit or a new branch
            COMMITS=$(git log --pretty=format:'\\item \\textbf{%h}: %s {\\small (%an, %ad)}' --date=short -n 5)
          else
            # Get commits between before and after
            COMMITS=$(git log --pretty=format:'\\item \\textbf{%h}: %s {\\small (%an, %ad)}' --date=short ${{ github.event.before }}..${{ github.sha }})
          fi
          
          # If no commits found, use the last one
          if [ -z "$COMMITS" ]; then
            COMMITS=$(git log --pretty=format:'\\item \\textbf{%h}: %s {\\small (%an, %ad)}' --date=short -n 1)
          fi
          
          # Save commits to a file because they might be multiline
          echo "$COMMITS" > commits.txt
          
          echo "Commits collected:"
          cat commits.txt
      
      - name: Inject git metadata into LaTeX
        run: |
          cd Demoproject
          
          # Read commits from file
          COMMITS=$(cat ../commits.txt)
          
          # Create the commits section for LaTeX
          if [ -z "$COMMITS" ]; then
            COMMITS_SECTION="\\begin{itemize}\\item No recent commits\\end{itemize}"
          else
            COMMITS_SECTION="\\begin{itemize}$COMMITS\\end{itemize}"
          fi
          
          # Replace placeholders using sed
          sed -e "s/GENERATION_DATE/${{ steps.git_info.outputs.date }}/g" \
              -e "s/GIT_AUTHOR/${{ steps.git_info.outputs.author }}/g" \
              outputs_report.tex > outputs_report_temp.tex
          
          # Replace GIT_COMMITS placeholder with the commits section
          # Use a temporary marker to avoid escaping issues
          echo "$COMMITS_SECTION" > commits_section.txt
          sed -e '/GIT_COMMITS/r commits_section.txt' -e '/GIT_COMMITS/d' outputs_report_temp.tex > outputs_report.tex
          
          # Clean up
          rm -f outputs_report_temp.tex commits_section.txt
          
          echo "LaTeX file updated with git metadata"
          
      - name: Compile LaTeX document
        uses: xu-cheng/latex-action@v3
        with:
          root_file: outputs_report.tex
          working_directory: Demoproject
          args: -pdf -file-line-error -interaction=nonstopmode
      
      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: outputs-report-pdf
          path: Demoproject/outputs_report.pdf
          retention-days: 90
